{% extends "base.html" %}
{% set active_page = "clients" %}

{% block title %}Clients â€” Freight Invoice Agent{% endblock %}

{% block content %}
<h2>Clients</h2>

<div style="display:flex; gap:0.5rem; margin-bottom:1rem;">
    <button id="filter-all" onclick="setFilter('')">All</button>
    <button id="filter-shipper" class="outline" onclick="setFilter('shipper')">Shippers</button>
    <button id="filter-consignee" class="outline" onclick="setFilter('consignee')">Consignees</button>
</div>

<article>
    <table>
        <thead>
            <tr>
                <th>Company Name</th>
                <th>Type</th>
                <th>Contact</th>
                <th>Email</th>
                <th>Country</th>
                <th>Payment Terms</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="clients-table">
            <tr><td colspan="7">Loading...</td></tr>
        </tbody>
    </table>
</article>
{% endblock %}

{% block scripts %}
<script>
let currentFilter = '';
let allClients = [];

function setFilter(type) {
    currentFilter = type;

    // Update button styles
    document.getElementById('filter-all').className = type === '' ? '' : 'outline';
    document.getElementById('filter-shipper').className = type === 'shipper' ? '' : 'outline';
    document.getElementById('filter-consignee').className = type === 'consignee' ? '' : 'outline';

    renderClients();
}

function renderClients() {
    const tbody = document.getElementById('clients-table');
    const filtered = currentFilter
        ? allClients.filter(c => c.client_type === currentFilter)
        : allClients;

    if (!filtered.length) {
        tbody.innerHTML = '<tr><td colspan="7">No clients found.</td></tr>';
        return;
    }

    tbody.innerHTML = filtered.map(c => `
        <tr>
            <td><a href="/clients/${c.id}">${c.company_name || ''}</a></td>
            <td>${c.client_type || ''}</td>
            <td>${c.contact_name || ''}</td>
            <td>${c.email || ''}</td>
            <td>${c.country || ''}</td>
            <td>${c.payment_terms || ''}</td>
            <td><a href="/clients/${c.id}">View</a></td>
        </tr>
    `).join('');
}

async function loadClients() {
    const tbody = document.getElementById('clients-table');
    tbody.innerHTML = '<tr><td colspan="7">Loading...</td></tr>';

    try {
        const resp = await fetch('/api/clients');
        if (!resp.ok) throw new Error('Failed to load clients: ' + resp.statusText);
        allClients = await resp.json();
        renderClients();
    } catch (err) {
        tbody.innerHTML = '<tr><td colspan="7">Error loading clients.</td></tr>';
        alert(err.message);
    }
}

document.addEventListener('DOMContentLoaded', loadClients);
</script>
{% endblock %}
